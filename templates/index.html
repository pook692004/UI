<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n lo·∫°i ·∫£nh</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Ph√¢n lo·∫°i ·∫£nh</h1>
            <p class="subtitle">T·∫£i l√™n ·∫£nh ho·∫∑c ch·ª•p ·∫£nh ƒë·ªÉ ph√¢n lo·∫°i</p>
        </header>
        
        <main>
            <div class="upload-container">
                <div class="tab-container">
                    <button class="tab-button active" onclick="switchTab('upload')">T·∫£i ·∫£nh l√™n</button>
                    <button class="tab-button" onclick="switchTab('camera')">Ch·ª•p ·∫£nh</button>
                </div>

                <div id="upload-tab" class="tab-content active">
                    <!-- Two columns layout similar to camera-tab -->
                    <div class="left-column">
                        <form id="uploadForm" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="upload-form">
                            <div class="file-input-container">
                                <input type="file" id="file" name="file" accept="image/*" required class="file-input" 
                                       onchange="autoSubmitForm()">
                                <label for="file" class="file-label">
                                    <span class="upload-icon">üìÅ</span>
                                    <span class="file-text">Ch·ªçn ·∫£nh</span>
                                </label>
                                <div id="file-name" class="file-name"></div>
                            </div>
                    </div>
                    <div class="right-column">
                        <div class="gallery-container">
                            <h3>Ch·∫•t l∆∞·ª£ng tr√°i c√¢y</h3>
                            <div id="uploadedImages" class="captured-images-list"></div>
                        </div>
                    </div>
                </div>

                <div id="camera-tab" class="tab-content">
                    <!-- Left column - Camera view and controls -->
                    <div class="left-column">
                        <div class="camera-container">
                            <video id="video" class="camera-preview" autoplay playsinline></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                            <div class="camera-controls">
                                <button id="startCamera" class="camera-button">B·∫≠t Camera</button>
                                <button id="startAutoCapture" class="camera-button" disabled>B·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông</button>
                                <button id="stopAutoCapture" class="camera-button" disabled>D·ª´ng ch·ª•p</button>
                            </div>
                            <div class="auto-status">
                                <p id="autoStatus" class="status-text">Ch∆∞a k√≠ch ho·∫°t ch·ª•p t·ª± ƒë·ªông</p>
                                <p id="countdownTimer" class="countdown-text"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right column - Gallery of captured images -->
                    <div class="right-column">
                        <div class="gallery-container">
                            <h3>Ch·∫•t l∆∞·ª£ng tr√°i c√¢y</h3>
                            <div id="capturedImages" class="captured-images-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>Quality Fruit</p>
        </footer>
    </div>

    <script>
// H√†m chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab (T·∫£i ·∫£nh l√™n v√† Ch·ª•p ·∫£nh)
function switchTab(tabName) {
    const tabs = document.querySelectorAll('.tab-content');  // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn n·ªôi dung tab
    const buttons = document.querySelectorAll('.tab-button');  // L·∫•y t·∫•t c·∫£ c√°c n√∫t tab
    
    tabs.forEach(tab => tab.classList.remove('active'));  // Lo·∫°i b·ªè l·ªõp 'active' kh·ªèi t·∫•t c·∫£ c√°c tab
    buttons.forEach(button => button.classList.remove('active'));  // Lo·∫°i b·ªè l·ªõp 'active' kh·ªèi t·∫•t c·∫£ c√°c n√∫t
    
    document.getElementById(`${tabName}-tab`).classList.add('active');  // Th√™m l·ªõp 'active' cho tab ƒë∆∞·ª£c ch·ªçn
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');  // Th√™m l·ªõp 'active' cho n√∫t ƒë∆∞·ª£c ch·ªçn
}

// H√†m hi·ªÉn th·ªã t√™n t·ªáp tin ƒë√£ ch·ªçn
function showFileName() {
    const input = document.getElementById('file');  // L·∫•y ph·∫ßn t·ª≠ input file
    const fileNameDiv = document.getElementById('file-name');  // L·∫•y ph·∫ßn t·ª≠ hi·ªÉn th·ªã t√™n file
    if (input.files.length > 0) {  // Ki·ªÉm tra xem c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn kh√¥ng
        fileNameDiv.textContent = input.files[0].name;  // Hi·ªÉn th·ªã t√™n c·ªßa file ƒë·∫ßu ti√™n ƒë∆∞·ª£c ch·ªçn
    }
}

// Kh·ªüi t·∫°o c√°c bi·∫øn ƒë·ªÉ x·ª≠ l√Ω camera
let stream = null;  // Bi·∫øn l∆∞u tr·ªØ lu·ªìng video
const video = document.getElementById('video');  // Ph·∫ßn t·ª≠ video hi·ªÉn th·ªã h√¨nh ·∫£nh t·ª´ camera
const canvas = document.getElementById('canvas');  // Canvas d√πng ƒë·ªÉ ch·ª•p ·∫£nh t·ª´ video
const startButton = document.getElementById('startCamera');  // N√∫t b·∫≠t camera
const startAutoButton = document.getElementById('startAutoCapture');  // N√∫t b·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông
const stopAutoButton = document.getElementById('stopAutoCapture');  // N√∫t d·ª´ng ch·ª•p t·ª± ƒë·ªông
const autoStatus = document.getElementById('autoStatus');  // Hi·ªÉn th·ªã tr·∫°ng th√°i ch·ª•p t·ª± ƒë·ªông
const countdownTimer = document.getElementById('countdownTimer');  // Hi·ªÉn th·ªã ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
const capturedImages = document.getElementById('capturedImages');  // Ph·∫ßn t·ª≠ ch·ª©a danh s√°ch ·∫£nh ƒë√£ ch·ª•p
const uploadedImages = document.getElementById('uploadedImages');  // Ph·∫ßn t·ª≠ ch·ª©a danh s√°ch ·∫£nh ƒë√£ t·∫£i l√™n

let captureInterval = null;  // Bi·∫øn l∆∞u tr·ªØ interval cho vi·ªác ch·ª•p t·ª± ƒë·ªông
let countdown = 5;  // Th·ªùi gian ƒë·∫øm ng∆∞·ª£c ban ƒë·∫ßu (5 gi√¢y)
let isCapturing = false;  // Tr·∫°ng th√°i ƒëang ch·ª•p

// H√†m  ƒë·ªÉ t·ª± ƒë·ªông g·ª≠i form khi ch·ªçn file
function autoSubmitForm() {
    showFileName();  // Hi·ªÉn th·ªã t√™n file tr∆∞·ªõc
    
    // T·∫°o ph·∫ßn t·ª≠ hi·ªÉn th·ªã cho ·∫£nh v·ª´a t·∫£i l√™n, b·∫Øt ƒë·∫ßu v·ªõi tr·∫°ng th√°i ƒëang t·∫£i
    const uploadItem = document.createElement('div');
    uploadItem.className = 'capture-item loading';
    uploadItem.innerHTML = `
        <div class="capture-time">${new Date().toLocaleTimeString()}</div>
        <div class="capture-loading">ƒêang ph√¢n t√≠ch...</div>
    `;
    uploadedImages.prepend(uploadItem); // Th√™m v√†o ƒë·∫ßu danh s√°ch
    
    // G·ª≠i form b·∫±ng Fetch API
    const formData = new FormData(document.getElementById('uploadForm'));
    
    fetch('{{ url_for("classify_only") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // C·∫≠p nh·∫≠t giao di·ªán v·ªõi k·∫øt qu·∫£ ph√¢n t√≠ch
        uploadItem.classList.remove('loading');
        uploadItem.innerHTML = `
            <div class="capture-item-inner">
                <img src="${data.image_url}" class="thumbnail" alt="·∫¢nh ƒë√£ t·∫£i l√™n">
                <div class="capture-details">
                    <div class="capture-time">${new Date().toLocaleTimeString()}</div>
                    <div class="capture-result ${getQualityClass(data.result)}">${data.result}</div>
                    <div class="capture-accuracy">ƒê·ªô ch√≠nh x√°c: ${data.accuracy.toFixed(2)}%</div>
                </div>
            </div>
        `;
        
        // Reset form sau khi t·∫£i l√™n th√†nh c√¥ng
        document.getElementById('file-name').textContent = '';
        document.getElementById('uploadForm').reset();
    })
    .catch(error => {
        console.error('Error analyzing image:', error);
        uploadItem.classList.remove('loading');
        uploadItem.innerHTML = `
            <div class="capture-time">${new Date().toLocaleTimeString()}</div>
            <div class="capture-error">L·ªói ph√¢n t√≠ch</div>
        `;
    });
}

// X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t b·∫Øt camera
startButton.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',  
                width: { ideal: 1280 },  // ƒê·ªô ph√¢n gi·∫£i chi·ªÅu r·ªông l√Ω t∆∞·ªüng
                height: { ideal: 720 }  // ƒê·ªô ph√¢n gi·∫£i chi·ªÅu cao l√Ω t∆∞·ªüng
            } 
        });
        video.srcObject = stream;  // G√°n lu·ªìng video v√†o ph·∫ßn t·ª≠ video
        startButton.disabled = true;  // V√¥ hi·ªáu h√≥a n√∫t b·∫≠t camera
        startAutoButton.disabled = false;  // K√≠ch ho·∫°t n√∫t ch·ª•p t·ª± ƒë·ªông
    } catch (err) {
        console.error('Error accessing camera:', err);  // In l·ªói v√†o console
        alert('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.');  // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
    }
});

// X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t b·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông
startAutoButton.addEventListener('click', () => {
    if (!isCapturing) {  // Ki·ªÉm tra n·∫øu ch∆∞a ƒëang trong tr·∫°ng th√°i ch·ª•p
        startAutomaticCapture();  // B·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông
        startAutoButton.disabled = true;  // V√¥ hi·ªáu h√≥a n√∫t b·∫Øt ƒë·∫ßu
        stopAutoButton.disabled = false;  // K√≠ch ho·∫°t n√∫t d·ª´ng
    }
});

// X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t d·ª´ng ch·ª•p
stopAutoButton.addEventListener('click', () => {
    stopAutomaticCapture();  // D·ª´ng ch·ª•p t·ª± ƒë·ªông
    startAutoButton.disabled = false;  // K√≠ch ho·∫°t l·∫°i n√∫t b·∫Øt ƒë·∫ßu
    stopAutoButton.disabled = true;  // V√¥ hi·ªáu h√≥a n√∫t d·ª´ng
});

// H√†m b·∫Øt ƒë·∫ßu qu√° tr√¨nh ch·ª•p t·ª± ƒë·ªông
function startAutomaticCapture() {
    isCapturing = true;  // ƒê√°nh d·∫•u ƒëang trong tr·∫°ng th√°i ch·ª•p
    countdown = 5;  // ƒê·∫∑t l·∫°i b·ªô ƒë·∫øm th·ªùi gian
    autoStatus.textContent = "ƒêang ch·ª•p t·ª± ƒë·ªông m·ªói 5 gi√¢y";  // C·∫≠p nh·∫≠t tr·∫°ng th√°i
    updateCountdown();  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·∫øm ng∆∞·ª£c
    
    captureInterval = setInterval(() => {  // Thi·∫øt l·∫≠p interval ch·∫°y m·ªói gi√¢y
        countdown--;  // Gi·∫£m b·ªô ƒë·∫øm th·ªùi gian
        if (countdown <= 0) {  // N·∫øu ƒë√£ ƒë·∫øn 0
            captureAndAnalyze();  // Ch·ª•p v√† ph√¢n t√≠ch ·∫£nh
            countdown = 5;  // ƒê·∫∑t l·∫°i b·ªô ƒë·∫øm th·ªùi gian
        }
        updateCountdown();  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·∫øm ng∆∞·ª£c
    }, 1000);  // M·ªói 1 gi√¢y
}

// H√†m d·ª´ng qu√° tr√¨nh ch·ª•p t·ª± ƒë·ªông
function stopAutomaticCapture() {
    isCapturing = false;  // ƒê√°nh d·∫•u kh√¥ng c√≤n trong tr·∫°ng th√°i ch·ª•p
    clearInterval(captureInterval);  // X√≥a interval
    autoStatus.textContent = "ƒê√£ d·ª´ng ch·ª•p t·ª± ƒë·ªông";  // C·∫≠p nh·∫≠t tr·∫°ng th√°i
    countdownTimer.textContent = "";  // X√≥a hi·ªÉn th·ªã ƒë·∫øm ng∆∞·ª£c
}

// H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·∫øm ng∆∞·ª£c
function updateCountdown() {
    countdownTimer.textContent = `Ch·ª•p ·∫£nh sau: ${countdown} gi√¢y`;  // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã th·ªùi gian c√≤n l·∫°i
}

// H√†m ch·ª•p v√† ph√¢n t√≠ch ·∫£nh
function captureAndAnalyze() {
    if (!stream) return;  // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ lu·ªìng video th√¨ tho√°t
    
    canvas.width = video.videoWidth;  // ƒê·∫∑t chi·ªÅu r·ªông canvas b·∫±ng v·ªõi video
    canvas.height = video.videoHeight;  // ƒê·∫∑t chi·ªÅu cao canvas b·∫±ng v·ªõi video
    canvas.getContext('2d').drawImage(video, 0, 0);  // V·∫Ω frame hi·ªán t·∫°i t·ª´ video l√™n canvas
    
    canvas.toBlob(blob => {  // Chuy·ªÉn ƒë·ªïi canvas th√†nh blob d·∫°ng file
        const formData = new FormData();  // T·∫°o form data ƒë·ªÉ g·ª≠i file
        formData.append('file', blob, `auto-capture-${Date.now()}.jpg`);  // Th√™m file v√†o form v·ªõi t√™n duy nh·∫•t
        
        // T·∫°o ph·∫ßn t·ª≠ hi·ªÉn th·ªã cho ·∫£nh v·ª´a ch·ª•p, b·∫Øt ƒë·∫ßu v·ªõi tr·∫°ng th√°i ƒëang t·∫£i
        const captureItem = document.createElement('div');
        captureItem.className = 'capture-item loading';
        captureItem.innerHTML = `
            <div class="capture-time">${new Date().toLocaleTimeString()}</div>
            <div class="capture-loading">ƒêang ph√¢n t√≠ch...</div>
        `;
        capturedImages.prepend(captureItem);  // Th√™m v√†o ƒë·∫ßu danh s√°ch (hi·ªÉn th·ªã tr√™n c√πng)
        
        // G·ª≠i ·∫£nh l√™n server ƒë·ªÉ ph√¢n t√≠ch
        fetch('{{ url_for("classify_only") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())  // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
        .then(data => {
            // C·∫≠p nh·∫≠t giao di·ªán v·ªõi k·∫øt qu·∫£ ph√¢n t√≠ch
            captureItem.classList.remove('loading');  // Lo·∫°i b·ªè tr·∫°ng th√°i ƒëang t·∫£i
            captureItem.innerHTML = `
                <div class="capture-item-inner">
                    <img src="${data.image_url}" class="thumbnail" alt="·∫¢nh ƒë√£ ch·ª•p">
                    <div class="capture-details">
                        <div class="capture-time">${new Date().toLocaleTimeString()}</div>
                        <div class="capture-result ${getQualityClass(data.result)}">${data.result}</div>
                        <div class="capture-accuracy">ƒê·ªô ch√≠nh x√°c: ${data.accuracy.toFixed(2)}%</div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            // X·ª≠ l√Ω khi c√≥ l·ªói
            console.error('Error analyzing image:', error);  // In l·ªói v√†o console
            captureItem.classList.remove('loading');  // Lo·∫°i b·ªè tr·∫°ng th√°i ƒëang t·∫£i
            captureItem.innerHTML = `
                <div class="capture-time">${new Date().toLocaleTimeString()}</div>
                <div class="capture-error">L·ªói ph√¢n t√≠ch</div>
            `;
        });
    }, 'image/jpeg', 0.9);  // ƒê·ªãnh d·∫°ng JPEG v·ªõi ch·∫•t l∆∞·ª£ng 90%
}

// H√†m l·∫•y l·ªõp CSS t∆∞∆°ng ·ª©ng v·ªõi k·∫øt qu·∫£ ch·∫•t l∆∞·ª£ng
function getQualityClass(result) {
    if (result.includes('Good')) return 'good-quality';  // N·∫øu c√≥ 'Good' th√¨ tr·∫£ v·ªÅ class ch·∫•t l∆∞·ª£ng t·ªët
    if (result.includes('Bad')) return 'bad-quality';  // N·∫øu c√≥ 'Bad' th√¨ tr·∫£ v·ªÅ class ch·∫•t l∆∞·ª£ng x·∫•u
    return 'mixed-quality';  // M·∫∑c ƒë·ªãnh tr·∫£ v·ªÅ class ch·∫•t l∆∞·ª£ng h·ªón h·ª£p
}

// D·ªçn d·∫πp camera khi chuy·ªÉn ƒë·ªïi tab
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        stopAutomaticCapture();  // D·ª´ng qu√° tr√¨nh ch·ª•p t·ª± ƒë·ªông
        if (stream) {  // N·∫øu c√≥ lu·ªìng video ƒëang ch·∫°y
            stream.getTracks().forEach(track => track.stop());  // D·ª´ng t·∫•t c·∫£ c√°c track
            stream = null;  // ƒê·∫∑t stream v·ªÅ null
            startButton.disabled = false;  // K√≠ch ho·∫°t l·∫°i n√∫t b·∫≠t camera
            startAutoButton.disabled = true;  // V√¥ hi·ªáu h√≥a n√∫t b·∫Øt ƒë·∫ßu ch·ª•p
            stopAutoButton.disabled = true;  // V√¥ hi·ªáu h√≥a n√∫t d·ª´ng ch·ª•p
        }
    });
});
    </script>
</body>
</html>